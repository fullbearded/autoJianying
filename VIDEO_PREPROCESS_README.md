# 视频预处理脚本使用说明

## 简介

`video_preprocess_cli.py` 是一个基于 `pyJianYingDraft` 库开发的视频预处理工具，完全基于 `interactive_cli.py` 的核心实现。它可以：

1. 遍历指定目录下的所有媒体文件（视频、图片、音频）
2. 基于现有草稿模板，为每个视频文件创建新的草稿
3. 使用直接JSON替换方法自动替换草稿中的素材文件
4. 批量生成多个草稿供后续剪辑使用

## 核心技术特性

### 基于 interactive_cli.py 的成熟实现
- **草稿读取**: 使用 `load_draft_info_from_file()` 兼容剪映5.9+和6.0+版本
- **文件兼容**: 通过 `get_compatible_draft_file_path()` 支持 `draft_info.json` 和 `draft_content.json`
- **素材替换**: 采用 `attempt_direct_json_replacement()` 直接操作JSON文件
- **视频处理**: 使用 `replace_video_material()` 完整处理视频素材信息

### 版本兼容性
- ✅ **剪映 5.9及以下**: 支持 `draft_content.json` 格式
- ✅ **剪映 6.0+**: 支持 `draft_info.json` 格式
- ✅ **自动检测**: 智能识别并使用正确的文件格式

## 主要功能

### 核心特性
- **目录扫描**: 递归扫描指定目录，支持多种媒体格式
- **模板复制**: 基于现有草稿作为模板进行复制
- **素材替换**: 自动替换模板中的视频素材
- **批量处理**: 为每个视频文件创建独立的草稿

### 支持的文件格式
- **视频**: .mp4, .mov, .avi, .mkv, .wmv, .flv, .webm
- **图片**: .jpg, .jpeg, .png, .bmp, .gif  
- **音频**: .mp3, .wav, .aac, .m4a, .flac

## 使用方法

### 基本运行
```bash
python video_preprocess_cli.py
```

### 运行流程
1. **初始化草稿文件夹**: 自动检测或手动设置剪映草稿文件夹路径
2. **选择模板草稿**: 从现有草稿中选择一个作为模板
3. **选择素材目录**: 指定包含待处理媒体文件的目录
4. **扫描文件**: 自动扫描目录中的所有支持格式文件
5. **生成草稿**: 为每个视频文件创建新的草稿副本

### 交互示例
```
==================================================
  视频预处理工具 - 基于目录的草稿生成
==================================================

------------------------------
  初始化草稿文件夹
------------------------------
📁 使用默认草稿路径: /Users/dada/Movies/JianyingPro/User Data/Projects/com.lveditor.draft
✅ 草稿文件夹初始化成功

------------------------------
  选择模板草稿
------------------------------
📊 找到 5 个可用草稿:
  1. 我的视频项目
  2. 模板草稿1
  3. 音乐视频模板
  4. 短视频模板
  5. 测试草稿
请选择模板草稿编号: 2
✅ 已选择模板草稿: 模板草稿1

------------------------------
  选择源素材目录
------------------------------
可选的素材目录:
  1. ./examples/materials ✅
  2. ./readme_assets/tutorial ✅
  3. 自定义路径
请选择素材目录编号: 1
✅ 已选择素材目录: ./examples/materials

------------------------------
  扫描目录文件
------------------------------
🎬 视频文件: 3 个
  - video1.mp4
  - video2.mov
  - video3.avi
🖼️ 图片文件: 2 个
  - image1.jpg
  - image2.png
🎵 音频文件: 1 个
  - audio1.mp3

------------------------------
  创建新草稿
------------------------------
📊 将基于 3 个视频文件创建草稿
确认创建 3 个草稿? (y/n): y

🔄 处理视频 1/3: video1.mp4
    ✅ 成功替换素材: 原视频.mp4 -> video1.mp4
✅ 成功创建草稿: 模板草稿1_processed_video1

🔄 处理视频 2/3: video2.mov
    ✅ 成功替换素材: 原视频.mp4 -> video2.mov
✅ 成功创建草稿: 模板草稿1_processed_video2

🔄 处理视频 3/3: video3.avi
    ✅ 成功替换素材: 原视频.mp4 -> video3.avi
✅ 成功创建草稿: 模板草稿1_processed_video3

📊 处理完成: 成功 3/3
✅ 视频预处理完成！
```

## 技术架构

### 类结构
- `VideoPreprocessCli`: 主要处理类
  - `initialize_draft_folder()`: 初始化草稿文件夹
  - `select_template_draft()`: 选择模板草稿
  - `select_source_directory()`: 选择源素材目录
  - `scan_directory_files()`: 扫描目录文件
  - `create_drafts_from_materials()`: 创建新草稿
  - `copy_and_replace_draft()`: 复制并替换草稿
  - `replace_primary_video_material()`: 替换主要视频素材

### 工作原理
1. **模板模式**: 使用 `pyJianYingDraft` 的 `duplicate_as_template()` 方法
2. **素材替换**: 通过 `replace_material_by_name()` 方法替换素材
3. **路径管理**: 自动适配不同操作系统的剪映路径

## 与 interactive_cli.py 的区别

| 特性 | interactive_cli.py | video_preprocess_cli.py |
|------|-------------------|-------------------------|
| 目标用途 | 批量复制草稿，组合式素材替换 | 基于目录的预处理 |
| 素材组织 | part1/part2/part3 文件夹结构 | 单一目录递归扫描 |
| 替换策略 | 多种素材类型组合 | 主要针对视频文件 |
| 用户交互 | 复杂的配置选项 | 简化的流程 |
| 适用场景 | 专业批量制作 | 快速预处理 |

## 注意事项

1. **模板要求**: 确保选择的模板草稿包含至少一个视频轨道和视频片段
2. **文件路径**: 素材文件路径不能包含特殊字符或中文字符（根据剪映版本而定）
3. **存储空间**: 批量创建草稿会占用较多存储空间
4. **权限问题**: 确保对草稿文件夹有读写权限

## 常见问题

### Q: 为什么某些视频文件创建草稿失败？
A: 可能的原因：
- 视频文件损坏或格式不兼容
- 模板草稿结构异常
- 磁盘空间不足
- 权限不足

### Q: 如何选择合适的模板草稿？
A: 建议：
- 选择结构简单的草稿作为模板
- 确保模板包含你需要的轨道类型
- 避免使用包含复杂效果的草稿作为模板

### Q: 可以同时处理多种类型的素材吗？
A: 当前版本主要针对视频文件，未来版本会支持：
- 图片素材的批量替换
- 音频素材的自动添加
- 多轨道的智能分配

## 扩展开发

如需扩展功能，可以：
1. 修改 `supported_*_extensions` 列表支持更多格式
2. 在 `create_drafts_from_materials()` 中添加图片和音频处理逻辑
3. 扩展 `replace_primary_video_material()` 支持多素材替换
4. 添加更多的用户配置选项

## 版本历史

- v1.0: 初始版本，支持基本的视频文件预处理功能